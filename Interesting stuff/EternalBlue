This ransomware utilized Eternalblue, a cyberweapon created by the NSA. It exploited a vulnerability on SMB
which allowed specifically crafted packets to be executed on the victim server.
Eternalblue relies on a Windows function named srv!SrvOS2FeaListSizeToNt.
it took advantage of three different bugs. 
1st a mathematical error when the protocol tries to cast an os/2 fileextended atrribute list structure 
to an NT FEA structure in order to determine how much memory to allocate. A miscalculations 
creates an integer overflow that causes less memory to be allocated than expected, which leads 
to a buffer overflow. The extra data can overflow into adjacent memory space. 
This is triggered by the second bug, which resdults from a difference in the SMB protocls definition of
two related sub commands SMB_COM_TRANSACTION2 and SMB_COM_NT_TRANSACT.
Both hace a scondary command that is used when ther eis too much data to include in a single packet/
The curucial difference between transaction and transact is that the latter calls for data packet twice the size of the formir.
This eror in validations occurs if the client sends a craftd mesage using transact sub commadn immediately before the trabnsaction one.
The protocl recognizes both, but it assigns both packets  based on the type of the last one, and since its smaller, 
the first packet will occupy more space than is allcoated.

The third bug in smbv1 allows heap spraying, a technique which results in allocating a c hink of memory at a given address. From 
here the attacker can write adn execute shellcode to take control of the system/ 

basically race condition, into buffer overflow, into heap spraying
